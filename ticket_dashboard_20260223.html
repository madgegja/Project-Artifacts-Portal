<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Toomics CS â€” Ticket Dashboard</title>
<style>
:root {
  --bg: #0f172a; --bg2: #1e293b; --bg3: #243044;
  --text: #e2e8f0; --text2: #94a3b8; --muted: #64748b;
  --blue: #0ea5e9; --cyan: #22d3ee; --green: #10b981;
  --amber: #f59e0b; --red: #ef4444; --purple: #a78bfa;
  --border: #334155; --border2: rgba(255,255,255,0.06);
  --radius: 12px; --sidebar-w: 480px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Malgun Gothic','Apple SD Gothic Neo','Noto Sans KR',-apple-system,sans-serif;
  background: var(--bg); color: var(--text);
  font-size: 13px; line-height: 1.5;
  height: 100vh; overflow: hidden;
  display: flex; flex-direction: column;
}

/* â”€â”€ Top Bar â”€â”€ */
.topbar {
  background: linear-gradient(135deg,#0f172a 0%,#1e3a5f 60%,#0ea5e9 100%);
  padding: 14px 24px; display: flex; align-items: center;
  gap: 16px; flex-shrink: 0; position: relative; overflow: hidden;
}
.topbar::before {
  content:''; position:absolute; top:-60px; right:-60px;
  width:220px; height:220px;
  background: radial-gradient(circle,rgba(14,165,233,0.18),transparent 70%);
  border-radius:50%;
}
.topbar-logo { font-size:18px; font-weight:800; letter-spacing:-0.3px; color:#fff; position:relative; }
.topbar-logo span { color: var(--cyan); }
.topbar-sub { font-size:11px; color:rgba(255,255,255,0.6); position:relative; margin-top:1px; }
.topbar-right { margin-left:auto; display:flex; align-items:center; gap:10px; position:relative; }
.auto-refresh-badge {
  font-size:11px; padding:3px 10px; border-radius:20px;
  background:rgba(16,185,129,0.15); color:#34d399;
  border:1px solid rgba(16,185,129,0.3); cursor:pointer;
  user-select:none; transition: all .2s;
}
.auto-refresh-badge.paused { background:rgba(100,116,139,0.15); color:var(--muted); border-color:rgba(100,116,139,0.3); }
.refresh-btn {
  background: rgba(14,165,233,0.15); border:1px solid rgba(14,165,233,0.3);
  color: var(--blue); padding:5px 12px; border-radius:8px; cursor:pointer;
  font-size:12px; font-weight:700; transition: all .2s;
}
.refresh-btn:hover { background: rgba(14,165,233,0.25); }
.last-updated { font-size:11px; color:rgba(255,255,255,0.5); }

/* â”€â”€ KPI Bar â”€â”€ */
.kpi-bar {
  background: var(--bg2); border-bottom:1px solid var(--border);
  padding: 12px 24px; display:flex; gap:16px; flex-shrink:0; overflow-x:auto;
}
.kpi-card {
  background: var(--bg3); border:1px solid var(--border);
  border-radius: 10px; padding:12px 18px; min-width:130px;
  cursor:pointer; transition: all .2s; position:relative; overflow:hidden;
  border-top: 3px solid transparent;
}
.kpi-card:hover { border-color: var(--blue); transform: translateY(-1px); }
.kpi-card.active { border-color: var(--blue) !important; background: rgba(14,165,233,0.08); }
.kpi-card .k-val { font-size:26px; font-weight:800; line-height:1.1; }
.kpi-card .k-lbl { font-size:11px; color:var(--text2); margin-top:3px; }
.kpi-card.k-new { border-top-color: var(--cyan); } .kpi-card.k-new .k-val { color:var(--cyan); }
.kpi-card.k-open { border-top-color: var(--blue); } .kpi-card.k-open .k-val { color:var(--blue); }
.kpi-card.k-pending { border-top-color: var(--amber); } .kpi-card.k-pending .k-val { color:var(--amber); }
.kpi-card.k-solved { border-top-color: var(--green); } .kpi-card.k-solved .k-val { color:var(--green); }
.kpi-card.k-today { border-top-color: var(--purple); } .kpi-card.k-today .k-val { color:var(--purple); }
.kpi-card.k-l1 { border-top-color: var(--red); } .kpi-card.k-l1 .k-val { color:var(--red); }

/* â”€â”€ Filter Bar â”€â”€ */
.filter-bar {
  background: var(--bg2); border-bottom:1px solid var(--border);
  padding: 10px 24px; display:flex; gap:10px; align-items:center; flex-shrink:0; flex-wrap:wrap;
}
.filter-bar input[type=text] {
  background: var(--bg3); border:1px solid var(--border); color:var(--text);
  padding:6px 12px; border-radius:8px; font-size:12px; width:220px; outline:none;
  transition: border-color .2s;
}
.filter-bar input[type=text]:focus { border-color:var(--blue); }
.filter-bar input[type=text]::placeholder { color:var(--muted); }
select.flt {
  background: var(--bg3); border:1px solid var(--border); color:var(--text);
  padding:5px 10px; border-radius:8px; font-size:12px; outline:none; cursor:pointer;
}
select.flt:focus { border-color: var(--blue); }
.filter-sep { width:1px; height:20px; background:var(--border); }
.clear-btn {
  background:transparent; border:1px solid var(--border); color:var(--muted);
  padding:5px 10px; border-radius:8px; cursor:pointer; font-size:11px; transition:all .2s;
}
.clear-btn:hover { border-color:var(--red); color:var(--red); }
.result-count { font-size:11px; color:var(--muted); margin-left:auto; }

/* â”€â”€ Main Layout â”€â”€ */
.main { display:flex; flex:1; overflow:hidden; }

/* â”€â”€ Ticket List â”€â”€ */
.ticket-list-pane {
  flex:1; overflow-y:auto; min-width:0;
}
.ticket-list-pane::-webkit-scrollbar { width:6px; }
.ticket-list-pane::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.ticket-row {
  display:grid;
  grid-template-columns: 70px 1fr 90px 80px 80px 90px 130px 42px;
  gap:0; align-items:center;
  padding:10px 16px; border-bottom:1px solid var(--border2);
  cursor:pointer; transition:background .15s; min-height:52px;
}
.ticket-row:hover { background: rgba(14,165,233,0.04); }
.ticket-row.active { background: rgba(14,165,233,0.08); border-left:3px solid var(--blue); }
.ticket-row.tr-l1 { border-left:3px solid var(--red); }
.ticket-row.tr-l2 { border-left:3px solid var(--amber); }
.ticket-row.tr-l3 { border-left:3px solid var(--green); }

.thead {
  background: var(--bg2); position:sticky; top:0; z-index:10;
  border-bottom:2px solid var(--border); font-size:11px;
  color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.5px;
}
.thead .ticket-row { min-height:36px; }
.thead .ticket-row:hover { background:transparent; cursor:default; }

.t-id { font-size:11px; font-weight:700; color:var(--text2); font-family:monospace; }
.t-subject { overflow:hidden; }
.t-subject .subj { font-weight:600; color:var(--text); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.t-subject .desc { font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px; }
.t-channel { font-size:11px; color:var(--text2); }
.t-level .badge, .t-cat .badge, .t-status .badge {
  display:inline-block; padding:2px 8px; border-radius:8px;
  font-size:10px; font-weight:700;
}
.badge-l1 { background:rgba(239,68,68,.15); color:#f87171; }
.badge-l2 { background:rgba(245,158,11,.15); color:#fbbf24; }
.badge-l3 { background:rgba(16,185,129,.15); color:#34d399; }
.badge-dash { color:var(--muted); }
.badge-new { background:rgba(34,211,238,.15); color:#22d3ee; }
.badge-open { background:rgba(14,165,233,.15); color:#38bdf8; }
.badge-pending { background:rgba(245,158,11,.15); color:#fbbf24; }
.badge-solved { background:rgba(16,185,129,.15); color:#34d399; }
.t-date { font-size:11px; color:var(--muted); }
.t-open-btn { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:4px; border-radius:6px; transition:all .2s; }
.t-open-btn:hover { background:rgba(14,165,233,.15); color:var(--blue); }

/* â”€â”€ Empty/Loading â”€â”€ */
.empty-state, .loading-state {
  text-align:center; padding:60px 40px; color:var(--muted);
}
.loading-state .spinner {
  width:32px; height:32px; border:3px solid var(--border);
  border-top-color:var(--blue); border-radius:50%;
  animation: spin .7s linear infinite; margin:0 auto 16px;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* â”€â”€ Pagination â”€â”€ */
.pagination { display:flex; align-items:center; justify-content:center; gap:8px; padding:12px; border-top:1px solid var(--border); }
.page-btn {
  background:var(--bg3); border:1px solid var(--border); color:var(--text2);
  padding:5px 12px; border-radius:8px; cursor:pointer; font-size:12px; transition:all .2s;
}
.page-btn:hover { border-color:var(--blue); color:var(--blue); }
.page-btn:disabled { opacity:.4; cursor:default; }
.page-btn.current { background:rgba(14,165,233,.15); border-color:var(--blue); color:var(--blue); }
.page-info { font-size:12px; color:var(--muted); }

/* â”€â”€ Sidebar Detail â”€â”€ */
.detail-sidebar {
  width: var(--sidebar-w); background:var(--bg2); border-left:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
  transform: translateX(100%); transition: transform .3s cubic-bezier(.4,0,.2,1);
  position:relative; flex-shrink:0;
}
.detail-sidebar.open { transform: translateX(0); }

.detail-header {
  padding:16px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:flex-start; gap:12px; flex-shrink:0;
}
.detail-header .dh-title { flex:1; min-width:0; }
.detail-header .dh-id { font-size:11px; font-weight:700; color:var(--blue); font-family:monospace; margin-bottom:4px; }
.detail-header .dh-subject { font-size:14px; font-weight:700; color:var(--text); line-height:1.4; }
.detail-close { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:18px; padding:2px; flex-shrink:0; }
.detail-close:hover { color:var(--text); }

.detail-meta {
  padding:12px 20px; border-bottom:1px solid var(--border);
  display:flex; flex-wrap:wrap; gap:8px; flex-shrink:0;
}
.meta-chip {
  font-size:11px; padding:3px 10px; border-radius:8px;
  background:var(--bg3); border:1px solid var(--border); color:var(--text2);
  display:flex; align-items:center; gap:4px;
}
.meta-chip .label { color:var(--muted); font-size:10px; }

.detail-body { flex:1; overflow-y:auto; padding:16px 20px; }
.detail-body::-webkit-scrollbar { width:5px; }
.detail-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.detail-actions {
  padding:12px 20px; border-top:1px solid var(--border);
  display:flex; gap:8px; flex-shrink:0;
}
.action-btn {
  flex:1; padding:8px; border-radius:8px; font-size:12px; font-weight:700;
  cursor:pointer; border:none; transition:all .2s; text-align:center; text-decoration:none;
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.action-btn.primary { background: var(--blue); color:#fff; }
.action-btn.primary:hover { background: #0284c7; }
.action-btn.secondary { background:var(--bg3); color:var(--text2); border:1px solid var(--border); }
.action-btn.secondary:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€ Comment â”€â”€ */
.comment-thread { display:flex; flex-direction:column; gap:12px; }
.comment-item { border-radius:10px; overflow:hidden; }
.comment-item.public { background: rgba(14,165,233,.06); border:1px solid rgba(14,165,233,.15); }
.comment-item.internal { background: rgba(245,158,11,.06); border:1px solid rgba(245,158,11,.15); }
.comment-meta {
  padding:7px 12px; display:flex; align-items:center; gap:8px; font-size:11px;
  border-bottom:1px solid rgba(255,255,255,.05);
}
.comment-meta .c-author { font-weight:700; color:var(--text2); }
.comment-meta .c-time { color:var(--muted); margin-left:auto; }
.comment-meta .c-badge { font-size:10px; padding:1px 6px; border-radius:6px; }
.c-pub { background:rgba(14,165,233,.15); color:#38bdf8; }
.c-int { background:rgba(245,158,11,.15); color:#fbbf24; }
.comment-body { padding:10px 12px; font-size:12px; color:var(--text2); line-height:1.7; white-space:pre-wrap; word-break:break-word; }

/* â”€â”€ Loading overlay for sidebar â”€â”€ */
.sidebar-loading { text-align:center; padding:40px; color:var(--muted); }
.sidebar-loading .spinner { width:28px; height:28px; border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 12px; }

/* â”€â”€ Error banner â”€â”€ */
.error-banner { background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.25); color:#f87171; border-radius:8px; padding:10px 14px; margin:8px 16px; font-size:12px; }

/* â”€â”€ Scrollbar global â”€â”€ */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<!-- â”€â”€ Top Bar â”€â”€ -->
<div class="topbar">
  <div>
    <div class="topbar-logo">Toomics <span>CS</span> Dashboard</div>
    <div class="topbar-sub">ì±—ë´‡ ì²˜ë¦¬ í‹°ì¼“ Â· ì´ë©”ì¼ ì œì™¸ Â· ì‹¤ì‹œê°„ ì¡°íšŒ</div>
  </div>
  <div class="topbar-right">
    <span class="last-updated" id="lastUpdated">â€“</span>
    <span class="auto-refresh-badge" id="arBadge" onclick="toggleAutoRefresh()">ğŸ”„ ìë™ê°±ì‹  ON</span>
    <button class="refresh-btn" onclick="loadAll()">â†» ìƒˆë¡œê³ ì¹¨</button>
  </div>
</div>

<!-- â”€â”€ KPI Bar â”€â”€ -->
<div class="kpi-bar" id="kpiBar">
  <div class="kpi-card k-new active" onclick="setStatusFilter('new')" data-s="new">
    <div class="k-val" id="kv-new">â€“</div><div class="k-lbl">ğŸ†• New</div>
  </div>
  <div class="kpi-card k-open" onclick="setStatusFilter('open')" data-s="open">
    <div class="k-val" id="kv-open">â€“</div><div class="k-lbl">ğŸ”µ Open</div>
  </div>
  <div class="kpi-card k-pending" onclick="setStatusFilter('pending')" data-s="pending">
    <div class="k-val" id="kv-pending">â€“</div><div class="k-lbl">ğŸŸ¡ Pending</div>
  </div>
  <div class="kpi-card k-solved" onclick="setStatusFilter('solved')" data-s="solved">
    <div class="k-val" id="kv-solved">â€“</div><div class="k-lbl">âœ… Solved</div>
  </div>
  <div class="kpi-card k-today" onclick="setStatusFilter('all')" data-s="today">
    <div class="k-val" id="kv-today">â€“</div><div class="k-lbl">ğŸ“… ì˜¤ëŠ˜ ì‹ ê·œ</div>
  </div>
  <div class="kpi-card k-l1" onclick="setLevelFilter('L1')" data-s="l1">
    <div class="k-val" id="kv-l1">â€“</div><div class="k-lbl">ğŸ”´ L1 ê¸´ê¸‰ (Open)</div>
  </div>
</div>

<!-- â”€â”€ Filter Bar â”€â”€ -->
<div class="filter-bar">
  <input type="text" id="searchInput" placeholder="ğŸ”  í‹°ì¼“ #, ì œëª©, ì´ë©”ì¼ ê²€ìƒ‰..." oninput="debounceSearch()" />
  <div class="filter-sep"></div>
  <select class="flt" id="statusFilter" onchange="applyFilters()">
    <option value="">ëª¨ë“  ìƒíƒœ</option>
    <option value="new">New</option>
    <option value="open">Open</option>
    <option value="pending">Pending</option>
    <option value="solved">Solved</option>
  </select>
  <select class="flt" id="channelFilter" onchange="applyFilters()">
    <option value="">ëª¨ë“  ì±„ë„</option>
    <option value="api">ì±—ë´‡</option>
    <option value="web">ì›¹</option>
    <option value="chat">ì±„íŒ…</option>
  </select>
  <select class="flt" id="levelFilter" onchange="applyFilters()">
    <option value="">ëª¨ë“  ë ˆë²¨</option>
    <option value="L1">L1 ê¸´ê¸‰</option>
    <option value="L2">L2 ê²€í† </option>
    <option value="L3">L3 ìë™</option>
  </select>
  <select class="flt" id="categoryFilter" onchange="applyFilters()">
    <option value="">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
    <option value="Subscription">Subscription</option>
    <option value="Refund">Refund</option>
    <option value="Account">Account</option>
    <option value="Payment">Payment</option>
    <option value="Content">Content</option>
    <option value="Technical">Technical</option>
    <option value="Fraud">Fraud</option>
  </select>
  <button class="clear-btn" onclick="clearFilters()">âœ• ì´ˆê¸°í™”</button>
  <span class="result-count" id="resultCount"></span>
</div>

<!-- â”€â”€ Main â”€â”€ -->
<div class="main">
  <!-- Ticket List -->
  <div class="ticket-list-pane" id="ticketListPane">
    <!-- thead -->
    <div class="thead">
      <div class="ticket-row">
        <span class="t-id">ID</span>
        <span class="t-subject">ì œëª©</span>
        <span class="t-channel">ì±„ë„</span>
        <span class="t-level">ë ˆë²¨</span>
        <span class="t-cat">ì¹´í…Œê³ ë¦¬</span>
        <span class="t-status">ìƒíƒœ</span>
        <span class="t-date">ì ‘ìˆ˜ì¼</span>
        <span></span>
      </div>
    </div>
    <!-- body -->
    <div id="ticketBody">
      <div class="loading-state"><div class="spinner"></div>í‹°ì¼“ ë¡œë”© ì¤‘...</div>
    </div>
    <div id="paginationBar" class="pagination" style="display:none;"></div>
  </div>

  <!-- Detail Sidebar -->
  <div class="detail-sidebar" id="detailSidebar">
    <div id="detailContent">
      <div class="sidebar-loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>
    </div>
    <div class="detail-actions" id="detailActions" style="display:none;">
      <a class="action-btn primary" id="zendeskLink" href="#" target="_blank">ğŸ”— Zendeskì—ì„œ ì—´ê¸°</a>
      <button class="action-btn secondary" onclick="closeSidebar()">âœ• ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEMO MODE â€” API ì—†ì´ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ë™ì‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_MODE = (location.protocol === 'file:' || location.hostname.includes('github.io') || !location.port);

const MOCK_TICKETS = [
  {id:48201, subject:"I want to cancel my subscription", description:"I signed up last month but I don't want to continue. Please cancel.", status:"solved", priority:"normal", channel:"ì±—ë´‡", level:"L3", category:"Subscription", tags:["l3","subscription","self_service","en"], created_at:"2026-02-23 09:14", updated_at:"2026-02-23 09:15",
   comments:[{id:1,body:"I want to cancel my subscription immediately. I signed up for the monthly plan but I don't want to continue.",author_id:1001,public:true,created_at:"2026-02-23 09:14"},{id:2,body:"We understand you'd like to cancel. Your subscription has been cancelled and you'll retain access until the end of your billing period. Is there anything else we can help with?",author_id:9001,public:true,created_at:"2026-02-23 09:15"},{id:3,body:"[BOT] Auto-resolved via self-service flow. Category: Subscription > Cancel. Market: EN.",author_id:9001,public:false,created_at:"2026-02-23 09:15"}]},
  {id:48202, subject:"ê²°ì œí–ˆëŠ”ë° ì½”ì¸ì´ ì•ˆ ë“¤ì–´ì™”ì–´ìš”", description:"30ë¶„ ì „ì— PayPalë¡œ ê²°ì œí–ˆëŠ”ë° ì½”ì¸ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.", status:"open", priority:"high", channel:"ì±—ë´‡", level:"L2", category:"Payment", tags:["l2","payment","paypal","kr"], created_at:"2026-02-23 10:32", updated_at:"2026-02-23 10:45",
   comments:[{id:4,body:"30ë¶„ ì „ì— PayPalë¡œ ê²°ì œí–ˆëŠ”ë° ì½”ì¸ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ëŠ” PP-2026022301234ì…ë‹ˆë‹¤.",author_id:1002,public:true,created_at:"2026-02-23 10:32"},{id:5,body:"ê²°ì œ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. PayPal íŠ¸ëœì­ì…˜ IDì™€ ê²°ì œ ê¸ˆì•¡ì„ í™•ì¸í•˜ì—¬ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",author_id:9001,public:true,created_at:"2026-02-23 10:33"},{id:6,body:"[BOT] Escalated to L2. Reason: Payment not credited after 30min. PayPal order ref provided.",author_id:9001,public:false,created_at:"2026-02-23 10:33"}]},
  {id:48203, subject:"Unauthorized charge on my credit card", description:"I see a charge of $29.99 from Toomics but I never signed up.", status:"new", priority:"urgent", channel:"ì›¹", level:"L1", category:"Fraud", tags:["l1","fraud","unauthorized","chargeback_risk","en"], created_at:"2026-02-23 11:05", updated_at:"2026-02-23 11:05",
   comments:[{id:7,body:"I just noticed a charge of $29.99 from Toomics on my Visa statement. I have never heard of this site and did not sign up. I need an immediate refund or I will file a chargeback with my bank.",author_id:1003,public:true,created_at:"2026-02-23 11:05"},{id:8,body:"[BOT] ğŸ”´ RED FLAG: Unauthorized claim + chargeback threat. Fraud score: HIGH. Escalated to L1 immediately.",author_id:9001,public:false,created_at:"2026-02-23 11:05"}]},
  {id:48204, subject:"Je ne peux pas me connecter Ã  mon compte", description:"J'ai oubliÃ© mon mot de passe et le lien de rÃ©initialisation ne fonctionne pas.", status:"solved", priority:"normal", channel:"ì±—ë´‡", level:"L3", category:"Account", tags:["l3","account","password_reset","fr"], created_at:"2026-02-23 08:22", updated_at:"2026-02-23 08:23",
   comments:[{id:9,body:"J'ai oubliÃ© mon mot de passe et le lien de rÃ©initialisation ne fonctionne pas. Pouvez-vous m'aider?",author_id:1004,public:true,created_at:"2026-02-23 08:22"},{id:10,body:"Nous comprenons que cela peut Ãªtre frustrant. Un nouveau lien de rÃ©initialisation a Ã©tÃ© envoyÃ© Ã  votre adresse email. Veuillez vÃ©rifier Ã©galement votre dossier spam.",author_id:9001,public:true,created_at:"2026-02-23 08:23"},{id:11,body:"[BOT] Auto-resolved. Password reset link re-sent. Market: FR.",author_id:9001,public:false,created_at:"2026-02-23 08:23"}]},
  {id:48205, subject:"Quiero un reembolso de mi suscripciÃ³n de 6 meses", description:"ComprÃ© la suscripciÃ³n de 6 meses por error, quiero el reembolso.", status:"pending", priority:"high", channel:"ì±—ë´‡", level:"L2", category:"Refund", tags:["l2","refund","subscription_6m","es"], created_at:"2026-02-23 07:45", updated_at:"2026-02-23 09:30",
   comments:[{id:12,body:"ComprÃ© la suscripciÃ³n de 6 meses por error. QuerÃ­a solo 1 mes. Necesito un reembolso por la diferencia.",author_id:1005,public:true,created_at:"2026-02-23 07:45"},{id:13,body:"Entendemos su situaciÃ³n. Hemos enviado su solicitud de reembolso al equipo de facturaciÃ³n para su revisiÃ³n. Le informaremos del resultado en un plazo de 24-48 horas.",author_id:9001,public:true,created_at:"2026-02-23 07:46"},{id:14,body:"[BOT] Escalated to L2. Refund eligibility check needed. 6-month plan, purchased today. Partial refund scenario.",author_id:9001,public:false,created_at:"2026-02-23 07:46"}]},
  {id:48206, subject:"The app keeps crashing on my Android phone", description:"Every time I open a chapter, the app crashes. Galaxy S24, Android 15.", status:"open", priority:"normal", channel:"ëª¨ë°”ì¼", level:"L2", category:"Technical", tags:["l2","technical","app_crash","android","en"], created_at:"2026-02-23 06:18", updated_at:"2026-02-23 08:00",
   comments:[{id:15,body:"Every time I try to read a chapter the app crashes. I'm using a Samsung Galaxy S24 with Android 15. I've already tried clearing cache and reinstalling.",author_id:1006,public:true,created_at:"2026-02-23 06:18"},{id:16,body:"We're sorry for the inconvenience. This seems to be a known issue with certain Android 15 devices. Our development team is working on a fix. In the meantime, you can try using our mobile web browser version.",author_id:9001,public:true,created_at:"2026-02-23 06:19"},{id:17,body:"[BOT] Escalated to L2. Known bug: Android 15 + Galaxy S24 crash. Ref: BUG-4521.",author_id:9001,public:false,created_at:"2026-02-23 06:19"}]},
  {id:48207, subject:"My child purchased coins without my permission", description:"My 12-year-old son used my PayPal to buy 500 coins.", status:"new", priority:"urgent", channel:"ì›¹", level:"L1", category:"Refund", tags:["l1","refund","unauthorized","minor","chargeback_risk","en"], created_at:"2026-02-23 11:50", updated_at:"2026-02-23 11:50",
   comments:[{id:18,body:"My 12-year-old son used my PayPal account to purchase 500 coins ($49.99) without my knowledge. I need a full refund. This is a minor using the service.",author_id:1007,public:true,created_at:"2026-02-23 11:50"},{id:19,body:"[BOT] ğŸ”´ RED FLAG: Minor usage + unauthorized PayPal + chargeback risk. Fraud score: HIGH. Escalated to L1.",author_id:9001,public:false,created_at:"2026-02-23 11:50"}]},
  {id:48208, subject:"Ich mÃ¶chte mein Konto und alle Daten lÃ¶schen", description:"GemÃ¤ÃŸ DSGVO mÃ¶chte ich die vollstÃ¤ndige LÃ¶schung meiner Daten.", status:"new", priority:"high", channel:"ì›¹", level:"L1", category:"Account", tags:["l1","account","gdpr","data_deletion","de"], created_at:"2026-02-23 10:00", updated_at:"2026-02-23 10:00",
   comments:[{id:20,body:"GemÃ¤ÃŸ Artikel 17 der DSGVO fordere ich die vollstÃ¤ndige LÃ¶schung meines Kontos und aller personenbezogenen Daten innerhalb von 30 Tagen.",author_id:1008,public:true,created_at:"2026-02-23 10:00"},{id:21,body:"[BOT] ğŸ”´ L1 Escalation: GDPR Art.17 data deletion request. Legal compliance required. Market: DE.",author_id:9001,public:false,created_at:"2026-02-23 10:00"}]},
  {id:48209, subject:"Como faÃ§o para trocar meu plano?", description:"Quero mudar do plano mensal para o trimestral.", status:"solved", priority:"normal", channel:"ì±—ë´‡", level:"L3", category:"Subscription", tags:["l3","subscription","plan_change","pt"], created_at:"2026-02-22 22:15", updated_at:"2026-02-22 22:16",
   comments:[{id:22,body:"Quero mudar do plano mensal para o trimestral. Como faÃ§o?",author_id:1009,public:true,created_at:"2026-02-22 22:15"},{id:23,body:"Ã‰ simples! VocÃª pode alterar seu plano acessando ConfiguraÃ§Ãµes > Assinatura > Alterar Plano. A diferenÃ§a de valor serÃ¡ calculada automaticamente.",author_id:9001,public:true,created_at:"2026-02-22 22:16"},{id:24,body:"[BOT] Auto-resolved. Plan change self-service guide provided. Market: PT.",author_id:9001,public:false,created_at:"2026-02-22 22:16"}]},
  {id:48210, subject:"à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸•à¸­à¸™à¸—à¸µà¹ˆà¸‹à¸·à¹‰à¸­à¹à¸¥à¹‰à¸§", description:"à¸‹à¸·à¹‰à¸­à¸•à¸­à¸™à¹„à¸›à¹à¸¥à¹‰à¸§à¹à¸•à¹ˆà¹€à¸›à¸´à¸”à¸­à¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸‚à¸¶à¹‰à¸™à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸‹à¸·à¹‰à¸­à¹ƒà¸«à¸¡à¹ˆ", status:"open", priority:"normal", channel:"ì±—ë´‡", level:"L2", category:"Content", tags:["l2","content","purchased_chapter","th"], created_at:"2026-02-23 05:40", updated_at:"2026-02-23 07:00",
   comments:[{id:25,body:"à¸‹à¸·à¹‰à¸­à¸•à¸­à¸™à¹„à¸›à¹à¸¥à¹‰à¸§à¹à¸•à¹ˆà¹€à¸›à¸´à¸”à¸­à¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸‚à¸¶à¹‰à¸™à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸‹à¸·à¹‰à¸­à¹ƒà¸«à¸¡à¹ˆà¸„à¸£à¸±à¸š à¸Šà¹ˆà¸§à¸¢à¹à¸à¹‰à¹„à¸‚à¹ƒà¸«à¹‰à¸”à¹‰à¸§à¸¢à¸„à¸£à¸±à¸š",author_id:1010,public:true,created_at:"2026-02-23 05:40"},{id:26,body:"à¸‚à¸­à¸­à¸ à¸±à¸¢à¹ƒà¸™à¸„à¸§à¸²à¸¡à¹„à¸¡à¹ˆà¸ªà¸°à¸”à¸§à¸à¸„à¸£à¸±à¸š à¹€à¸£à¸²à¹„à¸”à¹‰à¸ªà¹ˆà¸‡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹„à¸›à¸¢à¸±à¸‡à¸—à¸µà¸¡à¹€à¸—à¸„à¸™à¸´à¸„à¹€à¸à¸·à¹ˆà¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¹‰à¸§à¸„à¸£à¸±à¸š à¸ˆà¸°à¹à¸ˆà¹‰à¸‡à¸œà¸¥à¹ƒà¸«à¹‰à¸—à¸£à¸²à¸šà¹‚à¸”à¸¢à¹€à¸£à¹‡à¸§à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸„à¸£à¸±à¸š",author_id:9001,public:true,created_at:"2026-02-23 05:41"},{id:27,body:"[BOT] Escalated to L2. Purchased chapter not accessible. Possible sync issue. Market: TH.",author_id:9001,public:false,created_at:"2026-02-23 05:41"}]},
  {id:48211, subject:"Cancel subscription and refund request", description:"I cancelled 2 days ago but was charged again today.", status:"pending", priority:"high", channel:"ì±—ë´‡", level:"L2", category:"Subscription", tags:["l2","subscription","cancel","charged_after_cancel","en"], created_at:"2026-02-23 04:10", updated_at:"2026-02-23 06:30",
   comments:[{id:28,body:"I cancelled my subscription 2 days ago but I was charged again today. $9.99 on my Visa. I want a refund for this charge.",author_id:1011,public:true,created_at:"2026-02-23 04:10"},{id:29,body:"We're sorry about this. It appears the cancellation may not have processed before the billing cycle. We've escalated this to our billing team for a refund review.",author_id:9001,public:true,created_at:"2026-02-23 04:11"},{id:30,body:"[BOT] Escalated to L2. Charged after cancel claim. Needs billing verification.",author_id:9001,public:false,created_at:"2026-02-23 04:11"}]},
  {id:48212, subject:"How do I read premium chapters?", description:"I bought coins but don't know how to use them to unlock chapters.", status:"solved", priority:"low", channel:"ì±—ë´‡", level:"L3", category:"Content", tags:["l3","content","faq","coin_usage","en"], created_at:"2026-02-22 20:30", updated_at:"2026-02-22 20:31",
   comments:[{id:31,body:"I just bought 100 coins but I don't know how to use them to unlock premium chapters. Can you help?",author_id:1012,public:true,created_at:"2026-02-22 20:30"},{id:32,body:"Great question! To unlock a premium chapter: 1) Open the series, 2) Tap the locked chapter, 3) Click 'Unlock with Coins'. The coin cost is shown on each chapter. Happy reading!",author_id:9001,public:true,created_at:"2026-02-22 20:31"},{id:33,body:"[BOT] Auto-resolved. FAQ: How to use coins. Market: EN.",author_id:9001,public:false,created_at:"2026-02-22 20:31"}]}
];

const MOCK_STATS = { new:3, open:3, pending:2, solved:4, today:8, l1_open:3 };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPage = 1;
let totalTickets = 0;
let perPage = 25;
let autoRefresh = true;
let arTimer = null;
let searchTimer = null;
let activeTicketId = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  loadAll();
  scheduleAutoRefresh();
});

function loadAll() {
  loadStats();
  loadTickets();
  setLastUpdated();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  if (DEMO_MODE) {
    const d = MOCK_STATS;
    setText('kv-new', d.new); setText('kv-open', d.open);
    setText('kv-pending', d.pending); setText('kv-solved', d.solved);
    setText('kv-today', d.today); setText('kv-l1', d.l1_open);
    return;
  }
  try {
    const res = await fetch('/api/dashboard/stats');
    if (!res.ok) return;
    const d = await res.json();
    setText('kv-new', d.new ?? 'â€“');
    setText('kv-open', d.open ?? 'â€“');
    setText('kv-pending', d.pending ?? 'â€“');
    setText('kv-solved', d.solved ?? 'â€“');
    setText('kv-today', d.today ?? 'â€“');
    setText('kv-l1', d.l1_open ?? 'â€“');
  } catch(e) { console.warn('Stats load failed', e); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TICKETS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTickets(page = 1) {
  currentPage = page;
  const body = document.getElementById('ticketBody');
  body.innerHTML = '<div class="loading-state"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';
  document.getElementById('paginationBar').style.display = 'none';

  if (DEMO_MODE) {
    let filtered = [...MOCK_TICKETS];
    const s = val('statusFilter'); if (s) filtered = filtered.filter(t => t.status === s);
    const c = val('channelFilter'); if (c) { const m={'api':'ì±—ë´‡','web':'ì›¹','chat':'ì±„íŒ…'}; filtered = filtered.filter(t => t.channel === (m[c]||c)); }
    const l = val('levelFilter'); if (l) filtered = filtered.filter(t => t.level === l);
    const cat = val('categoryFilter'); if (cat) filtered = filtered.filter(t => t.category === cat);
    const q = val('searchInput').trim().toLowerCase(); if (q) filtered = filtered.filter(t => t.subject.toLowerCase().includes(q) || t.description.toLowerCase().includes(q) || String(t.id).includes(q));
    totalTickets = filtered.length;
    document.getElementById('resultCount').textContent = `ì´ ${totalTickets}ê±´`;
    renderTickets(filtered);
    renderPagination(filtered.length, 1);
    return;
  }

  const params = buildParams(page);
  try {
    const res = await fetch('/api/dashboard/tickets?' + params);
    const d = await res.json();
    if (d.error) {
      body.innerHTML = `<div class="error-banner">âš ï¸ ${d.error}</div>`;
      return;
    }
    totalTickets = d.total || 0;
    document.getElementById('resultCount').textContent = `ì´ ${totalTickets.toLocaleString()}ê±´`;
    renderTickets(d.tickets || []);
    renderPagination(d.total, page);
  } catch(e) {
    body.innerHTML = `<div class="error-banner">âš ï¸ ì—°ê²° ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

function buildParams(page) {
  const p = new URLSearchParams();
  const s = val('statusFilter'); if (s) p.set('status', s);
  const c = val('channelFilter'); if (c) p.set('channel', c);
  const l = val('levelFilter'); if (l) p.set('level', l);
  const cat = val('categoryFilter'); if (cat) p.set('category', cat);
  const q = val('searchInput').trim(); if (q) p.set('q', q);
  p.set('page', page); p.set('per_page', perPage);
  return p.toString();
}

function renderTickets(tickets) {
  const body = document.getElementById('ticketBody');
  if (!tickets.length) {
    body.innerHTML = '<div class="empty-state">ğŸ” í•´ë‹¹í•˜ëŠ” í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  body.innerHTML = tickets.map(t => {
    const lvl = t.level !== '-' ? `<span class="badge badge-${t.level.toLowerCase()}">${t.level}</span>` : '<span class="badge-dash">â€“</span>';
    const cat = `<span style="font-size:11px;color:var(--text2);">${t.category}</span>`;
    const sta = `<span class="badge badge-${t.status}">${statusLabel(t.status)}</span>`;
    const levelClass = t.level !== '-' ? `tr-${t.level.toLowerCase()}` : '';
    const activeClass = activeTicketId === t.id ? 'active' : '';
    return `
      <div class="ticket-row ${levelClass} ${activeClass}" onclick="openTicket(${t.id})" data-id="${t.id}">
        <span class="t-id">#${t.id}</span>
        <span class="t-subject">
          <div class="subj">${esc(t.subject)}</div>
          <div class="desc">${esc(t.description)}</div>
        </span>
        <span class="t-channel" style="font-size:11px;">${esc(t.channel)}</span>
        <span class="t-level">${lvl}</span>
        <span class="t-cat">${cat}</span>
        <span class="t-status">${sta}</span>
        <span class="t-date">${t.created_at}</span>
        <span><button class="t-open-btn" title="ìƒì„¸ ë³´ê¸°" onclick="event.stopPropagation();openTicket(${t.id})">â€º</button></span>
      </div>`;
  }).join('');
}

function renderPagination(total, page) {
  const bar = document.getElementById('paginationBar');
  const totalPages = Math.ceil(total / perPage);
  if (totalPages <= 1) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';

  let html = `<button class="page-btn" onclick="loadTickets(${page - 1})" ${page <= 1 ? 'disabled' : ''}>â€¹ ì´ì „</button>`;
  // Show window of pages
  const start = Math.max(1, page - 2), end = Math.min(totalPages, page + 2);
  if (start > 1) html += `<button class="page-btn" onclick="loadTickets(1)">1</button><span class="page-info">â€¦</span>`;
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i === page ? 'current' : ''}" onclick="loadTickets(${i})">${i}</button>`;
  }
  if (end < totalPages) html += `<span class="page-info">â€¦</span><button class="page-btn" onclick="loadTickets(${totalPages})">${totalPages}</button>`;
  html += `<button class="page-btn" onclick="loadTickets(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>ë‹¤ìŒ â€º</button>`;
  html += `<span class="page-info">${total.toLocaleString()}ê±´ / ${totalPages}í˜ì´ì§€</span>`;
  bar.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DETAIL SIDEBAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openTicket(id) {
  activeTicketId = id;
  // highlight row
  document.querySelectorAll('.ticket-row').forEach(r => r.classList.remove('active'));
  const row = document.querySelector(`.ticket-row[data-id="${id}"]`);
  if (row) row.classList.add('active');

  const sidebar = document.getElementById('detailSidebar');
  const content = document.getElementById('detailContent');
  const actions = document.getElementById('detailActions');
  sidebar.classList.add('open');
  actions.style.display = 'none';
  content.innerHTML = '<div class="sidebar-loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';

  try {
    let t;
    if (DEMO_MODE) {
      t = MOCK_TICKETS.find(tk => tk.id === id);
      if (!t) { content.innerHTML = '<div class="error-banner">âš ï¸ í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
      t = {...t, zendesk_url: `https://toomics.zendesk.com/agent/tickets/${id}`};
    } else {
      const res = await fetch(`/api/dashboard/tickets/${id}`);
      t = await res.json();
      if (t.error) { content.innerHTML = `<div class="error-banner">âš ï¸ ${t.error}</div>`; return; }
    }

    const lvlBadge = t.level !== '-'
      ? `<span class="badge badge-${t.level.toLowerCase()}">${t.level}</span>` : '';
    const staBadge = `<span class="badge badge-${t.status}">${statusLabel(t.status)}</span>`;

    content.innerHTML = `
      <div class="detail-header">
        <div class="dh-title">
          <div class="dh-id">#${t.id} Â· ${t.channel}</div>
          <div class="dh-subject">${esc(t.subject)}</div>
        </div>
        <button class="detail-close" onclick="closeSidebar()">âœ•</button>
      </div>
      <div class="detail-meta">
        ${staBadge}
        ${lvlBadge}
        <div class="meta-chip"><span class="label">ì¹´í…Œê³ ë¦¬</span>${t.category}</div>
        <div class="meta-chip"><span class="label">ì ‘ìˆ˜</span>${t.created_at}</div>
        <div class="meta-chip"><span class="label">ì—…ë°ì´íŠ¸</span>${t.updated_at}</div>
        ${t.tags.filter(tag => !['l1','l2','l3'].includes(tag.toLowerCase())).slice(0,4).map(tag => `<div class="meta-chip">${esc(tag)}</div>`).join('')}
      </div>
      <div class="detail-body">
        <div class="comment-thread">
          ${(t.comments || []).map((c, i) => `
            <div class="comment-item ${c.public ? 'public' : 'internal'}">
              <div class="comment-meta">
                <span class="c-author">${c.public ? 'ğŸ‘¤ ê³ ê°' : 'ğŸ”’ ë‚´ë¶€ë©”ëª¨'}</span>
                <span class="c-badge ${c.public ? 'c-pub' : 'c-int'}">${c.public ? 'Public' : 'Internal'}</span>
                <span class="c-time">${c.created_at}</span>
              </div>
              <div class="comment-body">${esc(c.body)}</div>
            </div>
          `).join('')}
        </div>
      </div>`;

    document.getElementById('zendeskLink').href = t.zendesk_url;
    actions.style.display = 'flex';
  } catch(e) {
    content.innerHTML = `<div class="error-banner">âš ï¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
  }
}

function closeSidebar() {
  document.getElementById('detailSidebar').classList.remove('open');
  document.querySelectorAll('.ticket-row').forEach(r => r.classList.remove('active'));
  activeTicketId = null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() { loadTickets(1); }

function setStatusFilter(s) {
  document.getElementById('statusFilter').value = s === 'all' ? '' : s;
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
  const active = document.querySelector(`.kpi-card[data-s="${s}"]`);
  if (active) active.classList.add('active');
  loadTickets(1);
}

function setLevelFilter(l) {
  document.getElementById('levelFilter').value = l;
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
  const active = document.querySelector(`.kpi-card[data-s="l1"]`);
  if (active) active.classList.add('active');
  loadTickets(1);
}

function clearFilters() {
  ['statusFilter','channelFilter','levelFilter','categoryFilter'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('searchInput').value = '';
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
  loadTickets(1);
}

function debounceSearch() {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => loadTickets(1), 400);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTO REFRESH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleAutoRefresh() {
  clearInterval(arTimer);
  if (autoRefresh) arTimer = setInterval(loadAll, 60000); // 1ë¶„ë§ˆë‹¤
}
function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  const badge = document.getElementById('arBadge');
  badge.textContent = autoRefresh ? 'ğŸ”„ ìë™ê°±ì‹  ON' : 'â¸ ìë™ê°±ì‹  OFF';
  badge.classList.toggle('paused', !autoRefresh);
  scheduleAutoRefresh();
}
function setLastUpdated() {
  const now = new Date();
  document.getElementById('lastUpdated').textContent =
    'ê°±ì‹ : ' + now.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusLabel(s) {
  return {new:'New', open:'Open', pending:'Pending', solved:'Solved', closed:'Closed'}[s] || s;
}
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function val(id) { return document.getElementById(id)?.value || ''; }
function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }
</script>
</body>
</html>
